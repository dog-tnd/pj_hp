---
import Layout from '../../layouts/Layout.astro';
import Menu from '../../components/menu';
import TwoLine from '../../components/TwoLine.astro';
import NewsCard from '../../components/NewsCard';

// ãƒ–ãƒ­ã‚°è¨˜äº‹ã®å‹å®šç¾©
interface BlogPost {
  frontmatter: {
    title: string;
    description: string;
    author: string;
    role: string;
    authorImage: string;
    date: string;
    image: string;
    tags?: string[];
  };
  url: string;
  file: string;
  Content: any;
}

// ãƒ–ãƒ­ã‚°è¨˜äº‹ã®å–å¾—ï¼ˆå‹ã‚­ãƒ£ã‚¹ãƒˆã‚’è¿½åŠ ï¼‰
const posts = await Astro.glob('../../content/blog/*.md') as BlogPost[];
const sortedPosts = posts.sort((a, b) => {
  return new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime();
});

// ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’åé›†ï¼ˆä½¿ç”¨é »åº¦é †ï¼‰
const tagCounts = new Map();
sortedPosts
  .filter(post => post.frontmatter.tags)
  .flatMap(post => post.frontmatter.tags || [])
  .forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });

// ä½¿ç”¨é »åº¦é †ã«ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸå…¨ã‚¿ã‚°
const allTagsSorted = Array.from(tagCounts.entries())
  .sort((a, b) => b[1] - a[1]) // ä½¿ç”¨é »åº¦ã®é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
  .map(([tag]) => tag);

// æœ€åˆã«è¡¨ç¤ºã™ã‚‹8å€‹ã®ã‚¿ã‚°
const primaryTags = allTagsSorted.slice(0, 8);
// æ®‹ã‚Šã®ã‚¿ã‚°
const remainingTags = allTagsSorted.slice(8);

// æœ€æ–°ã®è¨˜äº‹ã‚’å–å¾—
const featuredPost = sortedPosts[0];
const recentPosts = sortedPosts.slice(1, 4);
const remainingPosts = sortedPosts.slice(4);

// æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(dateString: string) {
  const date = new Date(dateString);
  if (isNaN(date.getTime())) {
    console.error(`Invalid date: ${dateString}`);
    return 'Invalid date';
  }
  return new Intl.DateTimeFormat('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}
---
<Layout title="ãƒ–ãƒ­ã‚° | ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚µãƒ¼ã‚¯ãƒ« TND">
  <header>
    <TwoLine />
  </header>

  <main class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <!-- Hero Section -->
    <div class="w-full max-w-full md:max-w-full custom-md:max-w-7xl mx-auto flex flex-col md:flex-row items-center gap-10 relative pt-20">
      <Menu client:load />
      <section class="mb-16">
        <h2 class="mb-8 text-gray-900 md:pt-[3rem]" style="color: #000; font-family: 'Rubik Doodle Shadow'; font-size: 38px; font-style: normal; font-weight: 400; line-height: normal;">Blog</h2>
        <div class="prose prose-lg max-w-xg text-gray-600 md:max-w-md lg:max-w-xl">
          <p>
            TNDãƒ¡ãƒ³ãƒãƒ¼ãŒæ›¸ã„ãŸæŠ€è¡“è¨˜äº‹ã‚„æ´»å‹•å ±å‘Šã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚„Webé–‹ç™ºã«é–¢ã™ã‚‹çŸ¥è¦‹ã‚’å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚
          </p>
        </div>

        <!-- ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="mt-8 md:mr-44 custom-md:mr-0">
          <h3 class="text-lg font-semibold mb-4 text-gray-900">ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿</h3>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-1 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 active:bg-blue-700 transition-colors tag-filter active" data-tag="all">
              ã™ã¹ã¦
            </button>
            {primaryTags.map(tag => (
              <button class={`px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-blue-500 hover:text-white active:bg-blue-700 transition-colors tag-filter`} data-tag={tag}>
                {tag}
              </button>
            ))}
            {remainingTags.length > 0 && (
              <>
                <div id="remaining-tags" class="hidden flex flex-wrap gap-2">
                  {remainingTags.map(tag => (
                    <button class={`px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-blue-500 hover:text-white active:bg-blue-700 transition-colors tag-filter`} data-tag={tag}>
                      {tag}
                    </button>
                  ))}
                </div>
                <button id="show-all-tags" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm hover:bg-gray-200 transition-colors border border-gray-300">
                  +{remainingTags.length}å€‹ã™ã¹ã¦è¡¨ç¤º
                </button>
                <button id="hide-tags" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm hover:bg-gray-200 transition-colors border border-gray-300 hidden">
                  æŠ˜ã‚ŠãŸãŸã‚€
                </button>
              </>
            )}
          </div>
        </div>
      </section>
    </div>

    <!-- ã™ã¹ã¦ã®è¨˜äº‹ -->
    <section id="all-posts" class="py-16 animate-fade-in animation-delay-300">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl font-bold mb-8 flex items-center">
          <span class="w-8 h-8 bg-blue-500 rounded-full mr-3 flex items-center justify-center text-white">
            ğŸ“
          </span>
          ã™ã¹ã¦ã®è¨˜äº‹
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full" id="posts-container">
          {sortedPosts.map((post, index) => {
            const slug = post.file.split('/').pop()?.replace('.md', '');
            const postUrl = `/blog/${slug}`;
            const postTags = post.frontmatter.tags || [];

            return (
              <div class="animate-fade-in post-card" style={`animation-delay: ${0.4 + (index % 6) * 0.1}s`} data-tags={JSON.stringify(postTags)}>
                <NewsCard
                  image={post.frontmatter.image}
                  title={post.frontmatter.title}
                  description={post.frontmatter.description}
                  author={post.frontmatter.author}
                  role={post.frontmatter.role}
                  authorImage={post.frontmatter.authorImage}
                  date={post.frontmatter.date}
                  url={postUrl}
                  client:load
                />
              </div>
            );
          })}
        </div>
      </div>
    </section>
  </main>

  <footer class="mt-24 border-t border-gray-200 py-8">
    <div class="mx-auto max-w-7xl px-4 text-center sm:px-6 lg:px-8">
      <p class="text-sm text-gray-500">Â© 2025 TND All Rights Reserved.</p>
    </div>
  </footer>

<script is:inline>
  // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
  document.addEventListener('DOMContentLoaded', function() {
    const tagFilters = document.querySelectorAll('.tag-filter');
    const postCards = document.querySelectorAll('.post-card');
    const showAllTagsBtn = document.getElementById('show-all-tags');
    const hideTagsBtn = document.getElementById('hide-tags');
    const remainingTags = document.getElementById('remaining-tags');

    // ã‚¿ã‚°è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
    if (showAllTagsBtn) {
      showAllTagsBtn.addEventListener('click', function() {
        remainingTags.classList.remove('hidden');
        remainingTags.classList.add('flex');
        showAllTagsBtn.classList.add('hidden');
        hideTagsBtn.classList.remove('hidden');
      });
    }

    if (hideTagsBtn) {
      hideTagsBtn.addEventListener('click', function() {
        remainingTags.classList.add('hidden');
        remainingTags.classList.remove('flex');
        hideTagsBtn.classList.add('hidden');
        showAllTagsBtn.classList.remove('hidden');
      });
    }

    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
    function updateTagFilters() {
      const currentTagFilters = document.querySelectorAll('.tag-filter');
      currentTagFilters.forEach(filter => {
        filter.addEventListener('click', function() {
          const selectedTag = filter.getAttribute('data-tag');

          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
          currentTagFilters.forEach(f => {
            f.classList.remove('active', 'bg-blue-500', 'text-white', 'bg-blue-600', 'bg-blue-700');
            f.classList.add('bg-gray-200', 'text-gray-700');
          });

          filter.classList.add('active', 'bg-blue-500', 'text-white');
          filter.classList.remove('bg-gray-200', 'text-gray-700');

          // è¨˜äº‹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          postCards.forEach(card => {
            const cardTags = JSON.parse(card.getAttribute('data-tags') || '[]');

            if (selectedTag === 'all' || cardTags.includes(selectedTag)) {
              card.classList.remove('hidden');
              card.classList.add('animate-fade-in');
            } else {
              card.classList.add('hidden');
              card.classList.remove('animate-fade-in');
            }
          });
        });
      });
    }

    // åˆæœŸåŒ–
    updateTagFilters();

    // ã‚¿ã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
    if (showAllTagsBtn) {
      showAllTagsBtn.addEventListener('click', function() {
        setTimeout(updateTagFilters, 0);
      });
    }
  });
</script>

<style>
  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
    opacity: 0;
  }

  .animation-delay-100 {
    animation-delay: 0.1s;
  }

  .animation-delay-200 {
    animation-delay: 0.2s;
  }

  .animation-delay-300 {
    animation-delay: 0.3s;
  }

  .animation-delay-400 {
    animation-delay: 0.4s;
  }

  /* ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  html {
    scroll-behavior: smooth;
  }
</style>
